
## Deployment

To deploy, you can use Azure CLI tools installed on your local machine or click
  **Deploy To Azure** button here.

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Futkarshayachit%2FAzureBatch-Secured%2Fazfinsim%2Fazuredeploy.json)

Using CLI, one can use the following form:
```sh
#-- login to CLI
az login

# set active subscription
az account set --subscription <subscription name>

#-- checkout the repo
git clone https://github.com/utkarshayachit/AzureBatch-Secured.git -b azfinsim 
cd AzureBatch-Secured

#-- deploy

# we use these variables just to make it easier to describe their purpose.

# Some nice and short name. This is used to identify the deployment. You can
# then easily monitor the progress on the Azure Portal
AZFS_DEPLOYMENT_NAME=dpl-azfinsim

# Location where all resources will be allocated
AZFS_LOCATION=eastus2

# A string to identify the creator. Just used to add tags to the resources/groups
# created to help identify them later.
AZFS_DEPLOYMENT_CREATOR=yourname

# A uniq string used in naming all resources. If not provided, one will be created
# automatically.
AZFS_PREFIX=some-small-uniq-string

az deployment sub create                  \
  --name $AZFS_DEPLOYMENT_NAME            \
  --location $AZFS_LOCATION               \
  --template-file main.bicep              \
  --parameters                            \
    resourceGroupLocation=$AZFS_LOCATION  \
    owner=$AZFS_DEPLOYMENT_CREATOR        \
    prefix=$AZFS_PREFIX
```

On success you'll be asked to enter a password to use to login to the jumbox VMs.
Create a secure password that you save since you'll need it later on. A mix of
upper case, lower case, and numbers is a good idea to aviod errors due to invalid
password.

This may take up to an hour.

If using the **Deploy To Azure** button, you'll be shown a lot more paramters
but only the ones set above in the CLI are sufficient.

On successful deployment, you can look at all resource groups created by browsing
to the **Resource Groups** listing in the Azure portal and then search for
`rg-dev-<prefix>`. If you didn't specify a prefix, and one was autogenerated, look at
the deployment details to find the prefix.

## Monitoring

To graphically monitor the pools/tasks and the computing activity,
we use **Azure Batch Explorer**. This is already deployed on the Windows Jumbox.
To view it, do the following:

- In the Azure Portal, search for `vm-jumbox-windows-1` under
  the `rg-dev-<prefix>-jumpbox` resource group.
- Navigate to the VM and Connect using Bastion. Use `localadmin` as the username
  (unless you changed that by specifying parameters during deployment) and then
  the password you choose during deployment. On success, you'll see the Windows box.
  When you login the first time, you'll choose some privacy settings etc.
  When done, you'll see a Windows desktop with **Batch Explorer** icon on the
  desktop. Double click to launch.
- **ISSUE**: The Batch Explorer may hang *Prompting for user input*, if it does that,
  right-click on its icon in the toolbar and choose close all windows. Next, using
  **Search**, search of Batch Explorer and launch the app again that way
  (don't use the desktop icon).
- Login to Azure using your credentials.
- The backaccount of interest is named `badev<prefix>01`. Select that and then you
  can inspect the pools etc.

## Executing the use-case

Once the cache is populated, we can submit jobs.
We use the linux jumbox to inject data into the database and submit jobs to process
the trades.

- In the Azure Portal, search for `vm-jumbox-linux-1` under
  the `rg-dev-<prefix>-jumpbox` resource group.
- Navigate to the VM and Connect using Bastion. Use `localadmin` as the username
  (unless you changed that by specifying parameters during deployment) and then
  the password you choose during deployment. On success, you'll see the Ubuntu terminal.
- In the shell, you need to do the following the first time to setup the Python enviroment
  
```sh
# install required Python packages
pip3 install -r /azfinsim/src/requirements.txt
```

### Populating the redis cache

We have two options to populate the cache.

```sh
# option 1: generates trades and pushes them. SLOW!
/azfinsim/scripts/generator.sh 
# here's the output
Generating synthetic trades
Incomplete environment configuration. These variables are set: AZURE_CLIENT_ID
[2022-09-19 22:13:55] [PID=2400]Starting trade generator...
[2022-09-19 22:13:55] [PID=2400]Generator Client: Logical Cores: 1
[2022-09-19 22:13:55] [PID=2400]Setting up cache connection
[2022-09-19 22:13:55] [PID=2400]Done.
[2022-09-19 22:13:55] [PID=2400]Starting the thread pool and filling the cache (1 threads)
[2022-09-19 22:13:55] [PID=2400]Generating 1000000 trades in range 0 to 999999
[2022-09-19 22:13:55] [PID=2400]Batchsize for pipeline to redis: 10000
[2022-09-19 22:13:55] [PID=2400]Generating batch: 0-9999
[2022-09-19 22:14:09] [PID=2400]Executing batch: 0-10000
[2022-09-19 22:14:10] [PID=2400]Generating batch: 10000-19999
[2022-09-19 22:14:22] [PID=2400]Executing batch: 10000-20000
[2022-09-19 22:14:23] [PID=2400]Generating batch: 20000-29999
[2022-09-19 22:14:32] [PID=2400]Executing batch: 20000-30000
[2022-09-19 22:14:32] [PID=2400]Generating batch: 30000-39999
[2022-09-19 22:14:42] [PID=2400]Executing batch: 30000-40000
[2022-09-19 22:14:42] [PID=2400]Generating batch: 40000-49999

#option 2: populates with pregenerated trades. FASTER!
/azfinsim/scripts/inject.sh 
# here's the output 
Grabbing information about redis from key valut
...
Injecting 1 million trades into cache devuda0919redis.redis.cache.windows.net:6379
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
All data transferred. Waiting for the last reply...
Last reply received from server.
errors: 0, replies: 1000000

real0m43.103s
user0m2.189s
sys0m0.741s
```

You can view the redis cache's memory usage go up as we populate it by navigating
to the *Insights* tab on the `dev<prefix>redis` resource under the `rg-dev-<prefix>` resource group.

## Submitting jobs

You can submit jobs using the `submit.sh`. By default it only submits 1 job with 10 tasks. Edit the file
to uncomment some larger runs.

```sh
 /azfinsim/scripts/submit.sh 
Using AZFINSIM_KEYVAULT_NAME=kv-dev-uda0919-ba
Incomplete environment configuration. These variables are set: AZURE_CLIENT_ID
[2022-09-19 22:31:20] [PID=3951]Starting job PV_MonteCarlo10K-20220919-223120 in pool linux-dev-pool
[2022-09-19 22:31:22] [PID=3951]Task task_000000, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Task task_000001, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Task task_000002, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Task task_000003, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Task task_000004, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Task task_000005, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Task task_000006, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Task task_000007, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Task task_000008, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Task task_000009, Command /bin/sh -c "/opt/azfinsim/src/azfinsim.py --keyvault kv-dev-uda0919-ba --cache-type redis --start-trade 0 --trade-window 100 --tasks 10 --task-duration 20 --format eyxml --algorithm pvonly --failu
re 0.0"
[2022-09-19 22:31:22] [PID=3951]Starting the thread pool (100 threads)
[2022-09-19 22:31:23] [PID=3951]Histogram of number of successful tasks submitted:
[2022-09-19 22:31:23] [PID=3951]0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,7
7,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100
[2022-09-19 22:31:23] [PID=3951]0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
[2022-09-19 22:31:23] [PID=3951]Thread pool complete: 10 tasks in 0.6144390106201172 seconds (16.27500830376572 tasks per second, 0 task failures)
[2022-09-19 22:31:23] [PID=3951]Finished adding tasks. Setting job to auto terminate once all tasks complete.
```

If you navigate to the **Batch Explorer** in the Windows jumbox, you'll see a new job with tasks has been added to the `linux-dev-pool`.

## Resizing pool

By default, the `linux-dev-pool` has no nodes allocated to it. You can resize it using either **Batch Explorer** or from
the linux jumpobox as follows:

```sh
# resize the pool to 10 (default set to 0)
/azfinsim/scripts/resize_pool.sh 10
```

## Cleanup

- Resize the pool down to 0
  
```sh
# resize the pool to 0
/azfinsim/scripts/resize_pool.sh 0
```

- Delete all resource groups named `rg-dev-<prefix>` using the Azure Portal.